<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blue Archive â€“ Advanced TL Assistant</title>
  <script src="utilities.js" onload="console.log('utilities.js loaded')" onerror="console.error('utilities.js failed to load')"></script>
  <script src="buffs.js" onload="console.log('buffs.js loaded')" onerror="console.error('buffs.js failed to load')"></script>
  <script src="input-processor.js" onload="console.log('input-processor.js loaded')" onerror="console.error('input-processor.js failed to load')"></script>
  <script src="tl-editor.js" onload="console.log('tl-editor.js loaded')" onerror="console.error('tl-editor.js failed to load')"></script>
  <script src="timeline-formatter.js" onload="console.log('timeline-formatter.js loaded')" onerror="console.error('timeline-formatter.js failed to load')"></script>
  <style>
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", sans-serif; 
      margin: 0; 
      padding: 24px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
      padding: 24px;
      text-align: center;
    }
    
    h1 { 
      font-size: 2rem; 
      margin: 0 0 8px; 
      font-weight: 700;
    }
    
    .subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      margin: 0;
    }
    
    .main-content {
      padding: 24px;
    }
    
    .controls { 
      display: flex; 
      gap: 12px; 
      flex-wrap: wrap; 
      align-items: center; 
      <!-- ç¸¦å¹…ã®èª¿æ•´ã¯marginã¨paddingã‚’èª¿ç¯€ã™ã‚‹ã“ã¨ã§è¡Œã„ã¾ã™ -->
      margin: 2px 0; 
      padding: 4px;
      background: #f8fafc;
      border-radius: 12px;
    }
    
    .btn { 
      padding: 4px 8px; 
      border-radius: 8px; 
      border: 2px solid transparent; 
      background: #4f46e5; 
      color: white;
      cursor: pointer; 
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .btn:hover { 
      background: #4338ca; 
      transform: translateY(-1px);
    }
    
    .btn.active { 
      background: #10b981; 
      border-color: #059669; 
    }
    
    .btn.secondary {
      background: #6b7280;
      color: white;
    }
    
    .btn.secondary:hover {
      background: #4b5563;
    }

    /* ã‚«ãƒã‚¨ãƒ»ãƒã‚§ãƒªãƒãƒœã‚¿ãƒ³ç”¨ã®å°ã•ãªã‚¹ã‚¿ã‚¤ãƒ« */
    .btn.small {
      padding: 4px 4px;
      font-size: 0.8rem;
      min-width: auto;
      margin: 1px 2px;
    }

    /* ã‚«ãƒã‚¨ãƒ»ãƒã‚§ãƒªãƒã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡Œã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’å°ã•ã */
    .controls.compact {
      gap: 0px;
      margin: 0px 0;
      padding: 0px;
    }
    
    /* è¨­å®šãƒ‘ãƒãƒ« */
    .settings-panel {
      background: #f1f5f9;
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
      border: 2px solid #e2e8f0;
    }
    
    /* è¨­å®šé …ç›®ã®è§£èª¬æ–‡ */
    .setting-comment {
      margin-left: 10px;
      color: #6b7280;
      font-size: 0.9rem;
      margin-top: 4px;
      margin-bottom: 12px;
    }
    
    /* åŸºæœ¬è¨­å®šã®2åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .settings-basic {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    
    @media (min-width: 768px) {
      .settings-basic {
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
    }
    
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .form-group label {
      font-weight: 600;
      color: #374151;
      font-size: 0.9rem;
    }
    
    .form-group input, .form-group select {
      padding: 8px 12px;
      border: 2px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º */
    .timeline-container { 
      display: flex; 
      flex-direction: column; 
      gap: 20px; 
    }
    
    @media (min-width: 900px) {
      .timeline-container { 
        flex-direction: row; 
      }
      .timeline-input-section { 
        flex: 0.45; 
      }
      .timeline-output-section { 
        flex: 0.55; 
      }
    }
    
    .input-section, .output-section {
      background: #f8fafc;
      border-radius: 12px;
      padding: 20px;
      border: 2px solid #e2e8f0;
    }
    
    .section-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #1f2937;
      margin: 0 0 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    textarea {
      width: 100%;
      height: 300px;
      padding: 12px;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      resize: vertical;
    }
    
    textarea:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    table { 
      border-collapse: collapse; 
      width: 100%; 
      margin: 16px 0;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    thead th { 
      position: sticky; 
      top: 0; 
      background: #4f46e5; 
      color: white;
      font-weight: 600;
    }
    
    th, td { 
      border: 1px solid #e5e7eb; 
      padding: 10px 12px; 
      font-variant-numeric: tabular-nums; 
      text-align: right; 
    }
    
    th:first-child, td:first-child, 
    th:nth-child(2), td:nth-child(2), 
    th:nth-child(3), td:nth-child(3), 
    th:nth-child(4), td:nth-child(4),
    th:nth-child(6), td:nth-child(6) { 
      text-align: center; 
    }
    
    tbody tr:nth-child(even) {
      background: #f9fafb;
    }
    
    tbody tr:hover {
      background: #f3f4f6;
    }
    
    .cost-overflow { 
      color: #dc2626; 
      font-weight: bold; 
      background: #fef2f2;
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    .cost-normal {
      color: #059669;
    }
    
    .remaining-cost { 
      color: #059669; 
      font-weight: bold; 
    }
    
    .muted { 
      color: #6b7280; 
      font-size: 0.9rem; 
    }
    
    .summary { 
      margin: 16px 0; 
      padding: 16px;
      background: white;
      border-radius: 8px;
      border-left: 4px solid #4f46e5;
    }
    
    .error-message {
      background: #fef2f2;
      color: #dc2626;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid #fecaca;
      margin: 16px 0;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      position: relative;
    }
    
    .success-message {
      background: #f0fdf4;
      color: #166534;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid #bbf7d0;
      margin: 16px 0;
    }
    
    .info-message {
      background: #eff6ff;
      color: #1d4ed8;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid #bfdbfe;
      margin: 16px 0;
    }
    
    /* JSONå‡ºåŠ›ã‚¨ãƒªã‚¢ */
    .json-output {
      background: #1f2937;
      color: #f9fafb;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      padding: 16px;
      border-radius: 8px;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
      border: 2px solid #374151;
    }
    
    /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ */
    .accordion {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      margin: 16px 0;
      overflow: hidden;
    }
    
    .accordion-header {
      background: #f3f4f6;
      padding: 12px 16px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .accordion-header:hover {
      background: #e5e7eb;
    }
    
    .accordion-content {
      padding: 16px;
      background: white;
      display: none;
    }
    
    .accordion.open .accordion-content {
      display: block;
    }
    
    .accordion.open .accordion-toggle::after {
      content: "âˆ’";
    }
    
    .accordion-toggle::after {
      content: "ï¼‹";
      font-weight: bold;
    }

    /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .timeline-display {
      background: #fff8e1;
      border: 1px solid #ffc947;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
      line-height: 1.6;
    }

    .timeline-row {
      display: flex;
      margin-bottom: 8px;
      padding: 4px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .timeline-row:last-child {
      border-bottom: none;
    }

    .timeline-event {
      flex: 0 0 300px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
    }

    .timeline-cost {
      flex: 1;
      padding-left: 16px;
      font-size: 0.85rem;
    }

    .remaining-cost {
      color: #1976d2;
      font-weight: bold;
    }

    .cost-overflow {
      color: #d32f2f;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ãƒ–ãƒ«ãƒ¼ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– TL Assistant</h1>
      <p class="subtitle">ã€è¶…é‡è¦ã€‘æœªå®Œæˆ - ãŠã‹ã—ã„ã“ã¨ã‚ã£ãŸã‚‰æ•™ãˆã¦ãã ã•ã„ï¼ï¼</p>
    </div>
    
    <div class="main-content">
      <!-- è¨­å®šãƒ‘ãƒãƒ« -->
      <div class="settings-panel">
        <h3 class="section-title">âš™ï¸ è¨­å®š</h3>
        
        <!-- åŸºæœ¬è¨­å®š -->
        <div class="settings-basic">
          <div class="controls">
            <span>æˆ¦é—˜æ™‚é–“ï¼š</span>
            <button class="btn" data-tt="180">180ç§’</button>
            <button class="btn" data-tt="240">240ç§’</button>
            <span id="currentTT" class="muted"></span>
          </div>

          <div class="controls">
            <span>ã‚³ã‚¹ãƒˆå›å¾©é‡å¢—åŠ SSï¼š</span>
            <button class="btn" data-ss="on">ã‚ªãƒ³</button>
            <button class="btn" data-ss="off">ã‚ªãƒ•</button>
            <span id="currentSS" class="muted"></span>
          </div>
          
          <div class="controls">
            <span>æœ€å¤§ã‚³ã‚¹ãƒˆï¼š</span>
            <button class="btn" data-limit="10">10</button>
            <button class="btn" data-limit="10.5">10.5</button>
            <button class="btn" data-limit="11">11</button>
            <span id="currentLimit" class="muted"></span>
          </div>

          <div class="controls">
            <span>ã‚»ã‚¤ã‚¢å›ºæœ‰2ï¼š</span>
            <button class="btn" data-seia="yes">ã‚ã‚Š</button>
            <button class="btn" data-seia="no">ãªã—</button>
            <span id="currentSeia" class="muted"></span>
          </div>

          <div class="controls compact">
            <span>ã‚«ãƒã‚¨ï¼š</span>
            <button class="btn small" data-kanoe="0">ãªã—</button>
            <button class="btn small" data-kanoe="1">æœ¬äººã®ã¿</button>
            <button class="btn small" data-kanoe="2">æœ¬äºº+1</button>
            <button class="btn small" data-kanoe="3">æœ¬äºº+2</button>
            <button class="btn small" data-kanoe="4">æœ¬äºº+3</button>
            <span id="currentKanoe" class="muted"></span>
          </div>

          <div class="controls compact">
            <span>ãƒã‚§ãƒªãƒï¼š</span>
            <button class="btn small" data-cherino="0">ãªã—</button>
            <button class="btn small" data-cherino="1">æœ¬äººã®ã¿</button>
            <button class="btn small" data-cherino="2">æœ¬äºº+1</button>
            <button class="btn small" data-cherino="3">æœ¬äºº+2</button>
            <button class="btn small" data-cherino="4">æœ¬äºº+3</button>
            <span id="currentCherino" class="muted"></span>
          </div>
        </div>

        <!-- è©³ç´°è¨­å®šï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ -->
        <div class="accordion">
          <div class="accordion-header" onclick="toggleAccordion(this)">
            ğŸ”§ è©³ç´°è¨­å®š
            <span class="accordion-toggle"></span>
          </div>
          <div class="accordion-content">
            <div class="controls">
              <span>ã€Œï¼šã€ã®ãªã„è¡Œé ­æ•°å­—ã®è§£é‡ˆï¼š</span>
              <button class="btn" data-number="time">ã‚¿ã‚¤ãƒ </button>
              <button class="btn" data-number="cost">ã‚³ã‚¹ãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°</button>
              <span id="currentNumber" class="muted"></span>
            </div>
            <div class="setting-comment">
              ä¾‹ãˆã°ã€Œ8.2 ã‚­ãƒ£ãƒ³ãƒ—ãƒãƒ¬ã€ã®å ´åˆã€8.2ã‚³ã‚¹ãƒˆã§ãƒãƒ¬ãªã®ã‹ã€é–‹å§‹8.2ç§’å¾Œã«ãƒãƒ¬ãªã®ã‹ã‚’è¨­å®šã—ã¾ã™ã€‚
            </div>

            <div class="controls">
              <span>æ™‚é–“è¡¨ç¤ºå½¢å¼ï¼š</span>
              <button class="btn" data-display="backward">ã‚²ãƒ¼ãƒ å†…è¡¨ç¤º</button>
              <button class="btn" data-display="forward">çµŒéæ™‚é–“</button>
              <span id="currentDisplay" class="muted"></span>
            </div>
            <div class="setting-comment">
              20.000ã‚ã‚‹ã„ã¯00:20.000ã‚’ã€ã‚²ãƒ¼ãƒ å†…è¡¨ç¤ºï¼ˆæ®‹ã‚Šæ™‚é–“ï¼‰å½¢å¼ã¨è§£é‡ˆã™ã‚‹ã‹ã€çµŒéã—ãŸæ™‚é–“ã¨è§£é‡ˆã™ã‚‹ã‹ã‚’è¨­å®šã—ã¾ã™ã€‚
            </div>

            <div class="controls">
              <span>+/-ã®è§£é‡ˆï¼š</span>
              <button class="btn" data-modifier="yes">å¸¸ã«ç§’å¾Œ/ç§’å‰</button>
              <button class="btn" data-modifier="no">è¡¨ç¤ºå½¢å¼ã«ä¾å­˜</button>
              <span id="currentModifier" class="muted"></span>
            </div>
            <div class="setting-comment">
              +/-ã‚’å¸¸ã«ã€‡ç§’å¾Œ/ç§’å‰ã¨è§£é‡ˆã™ã‚‹ã‹ã€ã‚ã‚‹ã„ã¯é€†ã¨ã—ã¦è§£é‡ˆã™ã‚‹ã‹ï¼ˆã‚²ãƒ¼ãƒ å†…è¡¨ç¤ºã®å ´åˆã®ã¿ï¼‰ã‚’è¨­å®šã—ã¾ã™ã€‚
            </div>

            <div class="controls">
              <span>ç‰¹æ®Šã‚³ãƒãƒ³ãƒ‰ã‚’å—ã‘ä»˜ã‘ã‚‹ï¼š</span>
              <button class="btn" data-special="yes">ã¯ã„</button>
              <button class="btn" data-special="no">ã„ã„ãˆ</button>
              <span id="currentSpecial" class="muted"></span>
            </div>
            <div class="setting-comment">
              ã€Œã‚³ã‚¹ãƒˆå›å¾©åŠ›ã€ã¨æ›¸ã„ã¦ã‚ã‚‹å ´åˆãã®è¡Œã‚’ã‚³ã‚¹ãƒˆå›å¾©åŠ›å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã¨ã¿ãªã—ã¾ã™ã€‚
            </div>
          </div>
        </div>
      </div>

      <!-- è¨˜å…¥æ–¹æ³• -->
      <div class="accordion">
        <div class="accordion-header" onclick="toggleAccordion(this)">
          ğŸ“– è¨˜å…¥æ–¹æ³•
          <span class="accordion-toggle"></span>
        </div>
        <div class="accordion-content">
          ã‚µãƒ³ãƒ—ãƒ«ã‚’è¦‹ã‚Œã°å¤§ä½“ã‚ã‹ã‚‹ã¨æ€ã†ã®ã§ã€ã¾ãšã‚µãƒ³ãƒ—ãƒ«ã‚’è¦‹ã¦ãã ã•ã„ã€‚<br>
          ã‚ã‹ã‚‰ãªã‘ã‚Œã°ä»¥ä¸‹ã®èª¬æ˜ã‚’å‚è€ƒã«ã—ã€ãã‚Œã§ã‚‚ã ã‚ãªã‚‰<a href="https://x.com/atsubakutaro">ã¼ã</a>ã«ç›´æ¥èã„ã¦ãã ã•ã„ã€‚
          <h4>è¨±ã•ã‚Œã‚‹è¨˜æ³•</h4>
          <ul>
            <li>2:43 [10] ãƒŸã‚« [6] - 2:43.000ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒŸã‚«ãŒ6ã‚³ã‚¹ãƒˆæ¶ˆè²»ã€ã‚³ã‚¹ãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°æŒ‡å®š[10]ã¯ç„¡è¦–ã•ã‚Œã‚‹ã€‚[ ]ã¯çœç•¥å¯èƒ½</li>
            <li>[9.8] ã‚»ã‚¤ã‚¢ [3] - 9.8ã‚³ã‚¹ãƒˆæºœã¾ã‚‹æœ€ã‚‚æ—©ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚»ã‚¤ã‚¢ãŒ3ã‚³ã‚¹ãƒˆæ¶ˆè²»</li>
            <li>ã‚¤ãƒ–ã‚­ [3] - [3]ã‚¤ãƒ–ã‚­[3]ã¨åŒã˜ã€‚3ã‚³ã‚¹ãƒˆã§ã‚¤ãƒ–ã‚­ãŒ3ã‚³ã‚¹ãƒˆæ¶ˆè²»</li>
            <li>[-2]ï¼£æ°´ç€ãƒŸã‚«[3] - ã‚³ã‚¹ãƒˆ-2ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ï¼£æ°´ç€ãƒŸã‚«ãŒ3ã‚³ã‚¹ãƒˆæ¶ˆè²»ã€‚æ°´ç€ãƒŠã‚®ã‚µå®Ÿè£…ã«ã‚ˆã‚Šã€ã“ã®ã‚ˆã†ãªãƒã‚¤ãƒŠã‚¹è¨˜æ³•ã‚‚è¨±ã•ã‚Œã‚‹</li>
          </ul>
            
          <h4>è©³ç´°</h4>
          <ul>
            <li><strong>è¡¨è¨˜ã‚†ã‚Œ</strong>: ç©ºç™½ã€[ ]ã®æœ‰ç„¡ã€å…¨è§’åŠè§’ãªã©ã®è¡¨è¨˜ã‚†ã‚Œã¯å¯èƒ½ãªé™ã‚Šè¨±ã™ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã‚‹ã®ã§åŸºæœ¬å¿ƒé…ä¸è¦</li>
            <li><strong>è¡Œã®åŸºæœ¬æ§‹é€ </strong>: ï¼ˆä½•ã‚‰ã‹ã®æ™‚é–“æŒ‡å®šï¼‰ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆåï¼‰ï¼ˆã‚³ã‚¹ãƒˆæ¶ˆè²»ï¼‰ï¼ˆãƒ©ãƒ™ãƒ«è¨­å®šï¼‰ã®æ§‹é€ ã€ä¸€éƒ¨çœç•¥å¯èƒ½</li>
            <li><strong>ãƒ©ãƒ™ãƒ«è¨­å®š</strong>: ç‰¹å®šã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã€Œ#ãƒŸã‚«1ã€ã®ã‚ˆã†ã«ãƒ©ãƒ™ãƒ«ã‚’è¨­å®šã—ã€ãã®æ™‚é–“ã‚’èµ·ç‚¹ã«åˆ¥ã®è¡Œå‹•ã®æ™‚é–“ã‚’æŒ‡å®šå¯èƒ½ã€‚ã€Œãƒ©ãƒ™ãƒ«å‚ç…§ã€ã‚’è¦‹ã‚‹ã“ã¨</li>
            <li><strong>ãƒ©ãƒ™ãƒ«å‚ç…§</strong>: è¡Œé ­ã«ã€Œ#ãƒŸã‚«1 +3.433ã€ã§ãƒ©ãƒ™ãƒ«ã‹ã‚‰3.433ç§’å¾Œã€ã€Œ#ãƒŸã‚«1 -2.167ã€ã§2.167ç§’å‰ï¼ˆè¨­å®šã§+/-ã®è§£é‡ˆåè»¢å¯èƒ½ï¼‰</li>
            <li><strong>çœç•¥ã—ãŸå ´åˆã®å‡¦ç†</strong>: 
              <ul>
                <li>æ¶ˆè²»ã‚³ã‚¹ãƒˆæŒ‡å®šãŒãªã„å ´åˆ: 0ã‚³ã‚¹ã§å®Ÿè¡Œã§ãã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã¨åˆ¤æ–­</li>
                <li>æ™‚é–“ãƒ»ã‚³ã‚¹ãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°æŒ‡å®šãŒãªã„å ´åˆ: æ¶ˆè²»ã‚³ã‚¹ãƒˆãŒæºœã¾ã‚‹æœ€é€Ÿã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã‚¹ã‚­ãƒ«ã‚’å®Ÿè¡Œ</li>
              </ul>
            </li>
            <li><strong>ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ</strong>: è¡Œé ­ã«ï¼ï¼ˆå…¨è§’ï¼ŒåŠè§’å¯ï¼‰ã‚’ã¤ã‘ãŸè¡Œã¯ç„¡è¦–ã•ã‚Œã‚‹ã®ã§ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦ä½¿ç”¨ã§ãã‚‹</li>
          </ul>

          <h4>ã‚³ã‚¹ãƒˆå›å¾©ãƒãƒ•å¯¾å¿œ</h4>
          <ul>
            <li>ä»¥ä¸‹ã®åå‰ã‚’å«ã‚“ã§ã„ã‚‹ã¨è‡ªå‹•çš„ã«ã‚³ã‚¹ãƒˆå›å¾©åŠ›ä¸Šæ˜‡ãƒãƒ•ãŒè¿½åŠ ã•ã‚Œã¾ã™ï¼š</li>
            <ul>
              <li><strong>æ°´ç€ãƒ›ã‚·ãƒ</strong>:ã€Œæ°´ã€ã¨ï¼ˆã€Œãƒ›ã‚·ãƒã€ã‚ã‚‹ã„ã¯ã€ŒãŠã˜ã€ï¼‰ã‚’å«ã‚“ã§ã„ã‚‹å ´åˆ</li>
              <li><strong>ã‚»ã‚¤ã‚¢</strong>: ã€Œã‚»ã‚¤ã‚¢ã€ã‚’å«ã‚€ãŒã€Œæ°´ã€ã‚’å«ã¾ãªã„å ´åˆ</li>
            </ul>
          </ul>
        </div>
      </div>

      <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
      <div class="controls">
        <button class="btn" onclick="triggerAutoUpdate()">ğŸš€ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆ</button>
        <button class="btn secondary" onclick="clearAll()">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
        <button class="btn" id="autoUpdateToggle" onclick="toggleAutoUpdate()">ğŸ”„ è‡ªå‹•æ›´æ–°: ON</button>
      </div>
      
      <!-- ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ -->
      <div class="controls" style="margin-top: 10px;">
        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-start;">
          <span style="font-weight: bold; margin-right: 10px; line-height: 32px;">ğŸ’¾ ã‚»ãƒ¼ãƒ–ã‚¹ãƒ­ãƒƒãƒˆ:</span>
          <div style="display: flex; flex-direction: column; gap: 2px;">
            <button class="btn secondary" onclick="saveToSlot(1)" style="font-size: 12px; padding: 4px 8px;">ä¿å­˜1</button>
            <button class="btn secondary" onclick="loadFromSlot(1)" style="font-size: 12px; padding: 4px 8px;">èª­è¾¼1</button>
          </div>
          <div style="display: flex; flex-direction: column; gap: 2px;">
            <button class="btn secondary" onclick="saveToSlot(2)" style="font-size: 12px; padding: 4px 8px;">ä¿å­˜2</button>
            <button class="btn secondary" onclick="loadFromSlot(2)" style="font-size: 12px; padding: 4px 8px;">èª­è¾¼2</button>
          </div>
          <div style="display: flex; flex-direction: column; gap: 2px;">
            <button class="btn secondary" onclick="saveToSlot(3)" style="font-size: 12px; padding: 4px 8px;">ä¿å­˜3</button>
            <button class="btn secondary" onclick="loadFromSlot(3)" style="font-size: 12px; padding: 4px 8px;">èª­è¾¼3</button>
          </div>
          <div style="display: flex; flex-direction: column; gap: 2px;">
            <button class="btn secondary" onclick="saveToSlot(4)" style="font-size: 12px; padding: 4px 8px;">ä¿å­˜4</button>
            <button class="btn secondary" onclick="loadFromSlot(4)" style="font-size: 12px; padding: 4px 8px;">èª­è¾¼4</button>
          </div>
          <div style="display: flex; flex-direction: column; gap: 2px;">
            <button class="btn secondary" onclick="saveToSlot(5)" style="font-size: 12px; padding: 4px 8px;">ä¿å­˜5</button>
            <button class="btn secondary" onclick="loadFromSlot(5)" style="font-size: 12px; padding: 4px 8px;">èª­è¾¼5</button>
          </div>
          <div style="display: flex; flex-direction: column; gap: 2px;">
            <button class="btn secondary" onclick="saveToSlot(6)" style="font-size: 12px; padding: 4px 8px;">ä¿å­˜6</button>
            <button class="btn secondary" onclick="loadFromSlot(6)" style="font-size: 12px; padding: 4px 8px;">èª­è¾¼6</button>
          </div>
          <div style="display: flex; flex-direction: column; gap: 2px;">
            <button class="btn secondary" onclick="saveToSlot(7)" style="font-size: 12px; padding: 4px 8px;">ä¿å­˜7</button>
            <button class="btn secondary" onclick="loadFromSlot(7)" style="font-size: 12px; padding: 4px 8px;">èª­è¾¼7</button>
          </div>
          <div style="display: flex; flex-direction: column; gap: 2px;">
            <button class="btn secondary" onclick="saveToSlot(8)" style="font-size: 12px; padding: 4px 8px;">ä¿å­˜8</button>
            <button class="btn secondary" onclick="loadFromSlot(8)" style="font-size: 12px; padding: 4px 8px;">èª­è¾¼8</button>
          </div>
          <div style="display: flex; flex-direction: column; gap: 2px;">
            <button class="btn secondary" onclick="saveToSlot(9)" style="font-size: 12px; padding: 4px 8px;">ä¿å­˜9</button>
            <button class="btn secondary" onclick="loadFromSlot(9)" style="font-size: 12px; padding: 4px 8px;">èª­è¾¼9</button>
          </div>
          <div style="display: flex; flex-direction: column; gap: 2px;">
            <button class="btn secondary" onclick="saveToSlot(10)" style="font-size: 12px; padding: 4px 8px;">ä¿å­˜10</button>
            <button class="btn secondary" onclick="loadFromSlot(10)" style="font-size: 12px; padding: 4px 8px;">èª­è¾¼10</button>
          </div>
        </div>
      </div>

      <!-- ãƒ¡ã‚¤ãƒ³ä½œæ¥­ã‚¨ãƒªã‚¢ -->
      <div class="timeline-container">
        <!-- å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="timeline-input-section">
          <div class="input-section">
            <h3 class="section-title">ğŸ“ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å…¥åŠ›</h3>
            <textarea id="timelineInput" placeholder="ä¾‹:
ï¼è¡Œé ­ã«ã€Œï¼ã€ã‚’æ›¸ãã¨ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã«ãªã‚Šç„¡è¦–ã•ã‚Œã¾ã™
!å…¨è§’ã§ã‚‚åŠè§’ã§ã‚‚ã„ã„ã§ã™ãŒã€çµµæ–‡å­—ã¯ãƒ€ãƒ¡ã§ã™â—
ï¼ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’è©¦ã—ãŸã„å ´åˆã¯ã‚µãƒ³ãƒ—ãƒ«6ã‚’æŠ¼ã—ã¦ãã ã•ã„
[5.0]æ°´ç€ãƒŠã‚®ã‚µ[3]
[6]ãƒãƒ¬[2] ä¸ŠæŒ¯ã‚Œã¦SSã§è¼ãƒšãƒ­ãƒ­å€’ã™ã¨ãƒªã‚¹ã‚¿
[8.5]ã‚«ãƒã‚¨[3]
[9.9]ã‚«ãƒ¨ã‚³[2]
[9.9]è‡¨æˆ¦[6]
03:22 ã‚­ã‚µã‚­[3]
03:18.433 ãƒŠã‚®ã‚µ[3]
03:14 ãƒãƒ¬[2] 
3:08.5 è‡¨æˆ¦[6]
[2]ã‚«ãƒ¨ã‚³[2]
[7]ãƒŠã‚®ã‚µ[3]
[5]ãƒãƒ¬[2]
[8.8]å³ç«¯è¼ããƒšãƒ­ãƒ­ãŒæŒ¯ã‚Šè¿”ã‚‹ç›´å‰è‡¨æˆ¦[6]
ã‚­ã‚µã‚­[3]
[4]ã‚«ãƒ¨ã‚³æ­©ãã¯ã˜ã‚ãŸã‚‰ã€è¶³æ­¢ã‚ã‚«ãƒ¨ã‚³EX[2]
ã‚«ãƒã‚¨[3]
[4]NSå¾Œãƒãƒ¬[2]
[3]ãƒŠã‚®ã‚µ[3]
[9.9]è‡¨æˆ¦[6]
ã‚­ã‚µã‚­[3]
ã‚«ãƒ¨ã‚³[2]
01:53.900 ãƒãƒ¬[2]
[1]è‡¨æˆ¦[6]"></textarea>
            
            <!-- ã‚µãƒ³ãƒ—ãƒ«ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
            <div style="margin-top: 16px;">
              <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-start;">
                <span style="font-weight: bold; margin-right: 10px; line-height: 32px;">ã‚µãƒ³ãƒ—ãƒ«:</span>
                <button class="btn secondary" onclick="loadSampleTimeline(1)" style="font-size: 12px; padding: 4px 8px;">1</button>
                <button class="btn secondary" onclick="loadSampleTimeline(2)" style="font-size: 12px; padding: 4px 8px;">2</button>
                <button class="btn secondary" onclick="loadSampleTimeline(3)" style="font-size: 12px; padding: 4px 8px;">3</button>
                <button class="btn secondary" onclick="loadSampleTimeline(4)" style="font-size: 12px; padding: 4px 8px;">4</button>
                <button class="btn secondary" onclick="loadSampleTimeline(5)" style="font-size: 12px; padding: 4px 8px;">5</button>
                <button class="btn secondary" onclick="loadSampleTimeline(6)" style="font-size: 12px; padding: 4px 8px;">6</button>
                <button class="btn secondary" onclick="loadSampleTimeline(7)" style="font-size: 12px; padding: 4px 8px;">7</button>
              </div>
            </div>
          </div>
        </div>

        <!-- å‡ºåŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="timeline-output-section">
          <div class="output-section">
            <h3 class="section-title">ï¿½ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å‡ºåŠ›</h3>
            
            <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section" id="timelineSection" style="display: none;">
              <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º -->
              <div id="timelineDisplay" class="timeline-display"></div>
              
              <!-- ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ -->
              <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                  ğŸ“„ ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
                  <span class="accordion-toggle"></span>
                </div>
                <div class="accordion-content">
                  <textarea id="timelineTextOutput" readonly style="height: 200px; font-family: 'Courier New', monospace; background: #f9f9f9;"></textarea>
                  <button class="btn secondary" onclick="copyTimelineText()" style="margin-top: 8px;">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="section" id="timelineResultsSection">
        <div class="output-section">
          <h3 class="section-title">ğŸ“Š ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³çµæœ</h3>
          <div id="timelineOutput">
            <div class="info-message">
              å·¦å´ã«ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å…¥åŠ›ã—ã¦ã€Œã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„
            </div>
          </div>
        </div>
      </div>

      <!-- è©³ç´°æƒ…å ±ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ -->
      <div class="accordion">
        <div class="accordion-header" onclick="toggleAccordion(this)">
          ğŸ” è©³ç´°æƒ…å ±ãƒ»ãƒ‡ãƒãƒƒã‚°
          <span class="accordion-toggle"></span>
        </div>
        <div class="accordion-content">
          <div id="debugInfo"></div>
        </div>
      </div>

      <!-- JSONå‡ºåŠ›ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ -->
      <div class="accordion">
        <div class="accordion-header" onclick="toggleAccordion(this)">
          ğŸ“‹ JSONå‡ºåŠ›
          <span class="accordion-toggle"></span>
        </div>
        <div class="accordion-content">
          <div id="jsonOutput"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =============================================================================
    // ğŸŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆè¨­å®šãƒ»çŠ¶æ…‹ç®¡ç†ï¼‰
    // =============================================================================
    
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ç®¡ç†
    let currentTimelineJSON = null;  // ç¾åœ¨å‡¦ç†ä¸­ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³JSONãƒ‡ãƒ¼ã‚¿
    let currentInputJSON = null;     // ç¾åœ¨ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®JSONè¡¨ç¾
    let autoUpdateTimer = null;      // è‡ªå‹•æ›´æ–°ç”¨ã®ã‚¿ã‚¤ãƒãƒ¼ID
    let autoUpdateEnabled = true;    // è‡ªå‹•æ›´æ–°æ©Ÿèƒ½ã®æœ‰åŠ¹/ç„¡åŠ¹ãƒ•ãƒ©ã‚°
    
    // ãƒãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜
    let buffData = window.BUFF_DATA || null;  // ãƒãƒ•åŠ¹æœãƒ‡ãƒ¼ã‚¿ã®å‚ç…§
    
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šå€¤ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
    const settings = {
      battle_time: 180,                     // æˆ¦é—˜æ™‚é–“ï¼ˆç§’ï¼‰
      ss_enabled: true,                     // SSæœ‰åŠ¹ãƒ•ãƒ©ã‚°
      max_cost: 10,                        // æœ€å¤§ã‚³ã‚¹ãƒˆè¨­å®š
      number_interpretation: 'cost',        // è¡Œé ­æ•°å­—ã®è§£é‡ˆæ–¹æ³•
      time_display_format: 'backward',      // æ™‚é–“è¡¨ç¤ºå½¢å¼ï¼ˆbackward/forwardï¼‰
      modifier_always_forward: 'yes',       // +/-ã®è§£é‡ˆæ–¹å‘
      seia_koyuu2: 'yes',                  // ã‚»ã‚¤ã‚¢å›ºæœ‰2ã®æœ‰ç„¡ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šã‚ã‚Šï¼‰
      kanoe_ss: '0',                       // ã‚«ãƒã‚¨ã®ãƒ¬ãƒ™ãƒ«ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šãªã—ï¼‰
      cherino_ss: '0',                     // ãƒã‚§ãƒªãƒã®ãƒ¬ãƒ™ãƒ«ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šãªã—ï¼‰
      special_command_accepted: 'yes'      // ç‰¹æ®Šã‚³ãƒãƒ³ãƒ‰ã‚’å—ã‘ä»˜ã‘ã‚‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šã¯ã„ï¼‰
    };

    // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã«é–¢é€£ã™ã‚‹è¨­å®šé …ç›®ã®ã‚­ãƒ¼ä¸€è¦§
    // ã“ã‚Œã‚‰ã®è¨­å®šã¯ã‚»ãƒ¼ãƒ–ã‚¹ãƒ­ãƒƒãƒˆã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã€ã‚¹ãƒ­ãƒƒãƒˆã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã™ã‚‹éš›ã«å¾©å…ƒã•ã‚Œã‚‹
    const timeline_related_setting_keys = [
      'battletime',
      'ss_enabled', 
      'max_cost',
      'seia_koyuu2',
      'kanoe_ss',
      'cherino_ss',
      'number_interpretation',
      'time_display_format',
      'modifier_always_forward',
      'special_command_accepted'
    ];

    // =============================================================================
    // ğŸ’¾ ã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰é–¢é€£
    // =============================================================================
    


    /**
     * applyLoadedSettings - èª­ã¿è¾¼ã¾ã‚ŒãŸè¨­å®šã‚’ç¾åœ¨ã®è¨­å®šã«å®‰å…¨ã«é©ç”¨
     * @param {Object} loaded_settings - èª­ã¿è¾¼ã¾ã‚ŒãŸè¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆä¸€éƒ¨ã®ã‚­ãƒ¼ãŒæœªå®šç¾©ã®å¯èƒ½æ€§ãŒã‚ã‚‹ï¼‰
     * 
     * loaded_settingsã¯åŸºæœ¬çš„ã«settingsã¨åŒã˜æ§‹é€ ã‚’æŒã¤ãŒã€ã„ãã¤ã‹ã®ã‚­ãƒ¼ãŒ
     * nullã‚„æœªå®šç¾©ã®å ´åˆãŒã‚ã‚‹ã€‚å®šç¾©ã•ã‚Œã¦ã„ã‚‹éƒ¨åˆ†ã®ã¿ç¾åœ¨ã®è¨­å®šã‚’ä¸Šæ›¸ãã™ã‚‹ã€‚
     * å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã€TLã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã«settingsã‚­ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆã§ã‚‚
     * å®‰å…¨ã«å‡¦ç†ã§ãã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã‚‹ã€‚
     */
    function applyLoadedSettings(loaded_settings) {
      if (!loaded_settings || typeof loaded_settings !== 'object') {
        console.log('è¨­å®šãƒ‡ãƒ¼ã‚¿ãŒç„¡åŠ¹ã¾ãŸã¯å­˜åœ¨ã—ã¾ã›ã‚“');
        return;
      }

      // å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼ã®ã¿ã‚’ç¾åœ¨ã®è¨­å®šã«é©ç”¨
      for (const key in loaded_settings) {
        if (loaded_settings.hasOwnProperty(key) && 
            settings.hasOwnProperty(key) && 
            loaded_settings[key] !== null && 
            loaded_settings[key] !== undefined) {
          settings[key] = loaded_settings[key];
        }
      }

      console.log('è¨­å®šã‚’é©ç”¨ã—ã¾ã—ãŸ:', settings);
    }
    
    /**
     * saveSettings - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã‚’localStorageã«ä¿å­˜
     * ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å†…å®¹ã‚’æ°¸ç¶šåŒ–ã™ã‚‹
     */
    function saveSettings() {
      localStorage.setItem('tl-assistant-settings', JSON.stringify(settings));
    }

    /**
     * loadSettings - localStorageã‹ã‚‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã‚’å¾©å…ƒ
     * ä¿å­˜ã•ã‚ŒãŸè¨­å®šå€¤ã‚’èª­ã¿è¾¼ã¿ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«é©ç”¨ã™ã‚‹
     * ã‚¨ãƒ©ãƒ¼æ™‚ã¯è­¦å‘Šã‚’å‡ºåŠ›ã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ç¶­æŒã™ã‚‹
     */
    function loadSettings() {
      try {
        const savedSettingsStr = localStorage.getItem('tl-assistant-settings');
        if (savedSettingsStr) {
          const savedSettings = JSON.parse(savedSettingsStr);
          
          // å¤ã„å½¢å¼ã®è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
          if (savedSettings.battleTime !== undefined) {
            // æ—§å½¢å¼ã‹ã‚‰ã®å¤‰æ›
            settings.battle_time = savedSettings.battleTime || settings.battle_time;
            settings.ss_enabled = savedSettings.ssEnabled !== undefined ? savedSettings.ssEnabled : settings.ss_enabled;
            settings.max_cost = savedSettings.maxCost || settings.max_cost;
            settings.number_interpretation = savedSettings.numberInterpretation || settings.number_interpretation;
            settings.time_display_format = savedSettings.timeDisplayFormat || settings.time_display_format;
            settings.modifier_always_forward = savedSettings.modifierAlwaysForward || settings.modifier_always_forward;
            settings.seia_koyuu2 = savedSettings.seiaKoyuu2 || settings.seia_koyuu2;
            settings.kanoe_ss = savedSettings.kanoeSS || settings.kanoe_ss;
            settings.cherino_ss = savedSettings.cherinoSS || settings.cherino_ss;
          } else {
            // æ–°å½¢å¼ã®è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥é©ç”¨
            Object.assign(settings, savedSettings);
          }
          
          console.log('è¨­å®šã‚’å¾©å…ƒã—ã¾ã—ãŸ:', settings);
        }
      } catch (error) {
        console.warn('è¨­å®šã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
      }
    }

    /**
     * saveToSlot - ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ­ãƒƒãƒˆåˆ¥ã«localStorageã«ä¿å­˜
     * @param {number} slotNumber - ä¿å­˜å…ˆã‚¹ãƒ­ãƒƒãƒˆç•ªå·ï¼ˆ1-10ï¼‰
     * æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ä¸Šæ›¸ãç¢ºèªã‚’è¡Œã†
     * ãƒ‡ãƒ¼ã‚¿å½¢å¼: {data: string, settings: object, timestamp: string, preview: string}
     */
    function saveToSlot(slotNumber) {
      const inputText = document.getElementById('timelineInput').value;
      if (!inputText.trim()) {
        showMessage('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
      }
      
      // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ä¸Šæ›¸ãç¢ºèª
      const existingData = localStorage.getItem(`tl-assistant-slot-${slotNumber}`);
      if (existingData) {
        const existing = JSON.parse(existingData);
        const confirmMessage = `ã‚¹ãƒ­ãƒƒãƒˆ${slotNumber}ã«ã¯æ—¢ã«ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚\n` +
                             `ä¿å­˜æ—¥æ™‚: ${existing.timestamp}\n` +
                             `ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: ${existing.preview}\n\n` +
                             `ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`;
        if (!confirm(confirmMessage)) {
          return;
        }
      }
      
      // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³é–¢é€£è¨­å®šã‚’æŠ½å‡º
      const timelineSettings = {};
      for (const key of timeline_related_setting_keys) {
        if (settings.hasOwnProperty(key)) {
          timelineSettings[key] = settings[key];
        }
      }
      
      const saveData = {
        data: inputText,
        settings: timelineSettings,
        timestamp: new Date().toLocaleString('ja-JP'),
        preview: inputText.substring(0, 50) + (inputText.length > 50 ? '...' : '')
      };
      
      localStorage.setItem(`tl-assistant-slot-${slotNumber}`, JSON.stringify(saveData));
      showMessage(`ã‚¹ãƒ­ãƒƒãƒˆ${slotNumber}ã«ä¿å­˜ã—ã¾ã—ãŸï¼ˆè¨­å®šã‚‚å«ã‚€ï¼‰`, 'success');
    }

    /**
     * loadFromSlot - ã‚¹ãƒ­ãƒƒãƒˆåˆ¥localStorageã‹ã‚‰ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
     * @param {number} slotNumber - èª­ã¿è¾¼ã¿å…ƒã‚¹ãƒ­ãƒƒãƒˆç•ªå·ï¼ˆ1-10ï¼‰
     * ç¾åœ¨ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ä¸Šæ›¸ãè­¦å‘Šã‚’è¡¨ç¤º
     * èª­ã¿è¾¼ã¿å¾Œã¯è‡ªå‹•æ›´æ–°ã‚’å®Ÿè¡Œã—ã¦ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å‡¦ç†
     */
    function loadFromSlot(slotNumber) {
      const savedDataStr = localStorage.getItem(`tl-assistant-slot-${slotNumber}`);
      if (!savedDataStr) {
        showMessage(`ã‚¹ãƒ­ãƒƒãƒˆ${slotNumber}ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“`, 'error');
        return;
      }
      
      // ç¾åœ¨ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ä¸Šæ›¸ãè­¦å‘Š
      const currentInput = document.getElementById('timelineInput').value;
      if (currentInput.trim()) {
        const currentPreview = currentInput.substring(0, 50) + (currentInput.length > 50 ? '...' : '');
        const confirmMessage = `ç¾åœ¨ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¿ã«ã‚ˆã£ã¦æ¶ˆå»ã•ã‚Œã¾ã™ã€‚\n` +
                             `ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿: ${currentPreview}\n\n` +
                             `ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`;
        if (!confirm(confirmMessage)) {
          return;
        }
      }
      
      try {
        const saveData = JSON.parse(savedDataStr);
        document.getElementById('timelineInput').value = saveData.data;
        
        // è¨­å®šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯èª­ã¿è¾¼ã¿
        if (saveData.settings) {
          applyLoadedSettings(saveData.settings);
          // è¨­å®šUIã‚’æ›´æ–°
          updateActiveButtons();
          saveSettings(); // ç¾åœ¨ã®è¨­å®šã‚’ä¿å­˜
          showMessage(`ã‚¹ãƒ­ãƒƒãƒˆ${slotNumber}ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã¨è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ (ä¿å­˜æ—¥æ™‚: ${saveData.timestamp})`, 'success');
        } else {
          showMessage(`ã‚¹ãƒ­ãƒƒãƒˆ${slotNumber}ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ (ä¿å­˜æ—¥æ™‚: ${saveData.timestamp})`, 'success');
        }
        
        // è‡ªå‹•æ›´æ–°ã‚’ä½¿ç”¨ã—ã¦å‡¦ç†ã‚’å®Ÿè¡Œ
        triggerAutoUpdate();
      } catch (error) {
        showMessage(`ã‚¹ãƒ­ãƒƒãƒˆ${slotNumber}ã®ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã¾ã™`, 'error');
      }
    }

    /**
     * saveToLocal - æ—§é–¢æ•°ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
     * saveToSlot(1)ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹
     */
    function saveToLocal() {
      saveToSlot(1);
    }

    /**
     * loadFromLocal - æ—§é–¢æ•°ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰  
     * loadFromSlot(1)ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹
     */
    function loadFromLocal() {
      loadFromSlot(1);
    }

    // =============================================================================
    // ğŸ”§ åˆæœŸåŒ–ãƒ»è¨­å®šç®¡ç†
    // =============================================================================
    
    /**
     * åˆæœŸåŒ– - DOMContentLoadedã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
     * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•æ™‚ã«å¿…è¦ãªåˆæœŸåŒ–å‡¦ç†ã‚’é †æ¬¡å®Ÿè¡Œ
     * å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ç¢ºèªã€è¨­å®šå¾©å…ƒã€UIåˆæœŸåŒ–ã‚’è¡Œã†
     */
    document.addEventListener('DOMContentLoaded', function() {
      // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
      setTimeout(() => {
        console.log('Checking dependencies...');
        console.log('window.Utilities:', typeof window.Utilities);
        console.log('window.TLCommon:', typeof window.TLCommon);
        console.log('window.InputProcessor:', typeof window.InputProcessor);
        console.log('window.TLEditor:', typeof window.TLEditor);
        console.log('window.TimelineFormatter:', typeof window.TimelineFormatter);
        
        // å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ç¢ºèª
        checkDependencies();
        
        // ãƒãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        loadBuffData();
        
        // ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’å¾©å…ƒ
        loadSettings();
        
        // è¨­å®šãƒœã‚¿ãƒ³ã®åˆæœŸåŒ–
        setupSettingsButtons();
        updateActiveButtons();
        
        // è‡ªå‹•æ›´æ–°ã®ãŸã‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        setupAutoUpdate();
        
        // è‡ªå‹•æ›´æ–°ãƒœã‚¿ãƒ³ã®åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
        const autoUpdateButton = document.getElementById('autoUpdateToggle');
        if (autoUpdateEnabled) {
          autoUpdateButton.classList.add('active');
        }
      }, 200); // å°‘ã—é•·ã‚ã«å¾…æ©Ÿã—ã¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’ç¢ºä¿
    });

    /**
     * loadBuffData - ãƒãƒ•ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
     * buffs.jsã‹ã‚‰æä¾›ã•ã‚Œã‚‹ãƒãƒ•åŠ¹æœãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¨­å®š
     * ãƒãƒ•è¨ˆç®—ã«å¿…è¦ãªåŸºç¤ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã™ã‚‹
     */
    function loadBuffData() {
      // buffs.jsã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã¿æ¸ˆã¿
      buffData = window.BUFF_DATA || null;
      
      // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚° - AIå‘ã‘æŒ‡ç¤ºï¼šã“ã‚Œã¯æ®‹ã™
      if (buffData) {
        console.log('ãƒãƒ•ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', buffData);
      } else {
        console.error('ãƒãƒ•ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚buffs.jsãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      }
    }

    /**
     * setupAutoUpdate - è‡ªå‹•æ›´æ–°æ©Ÿèƒ½ã®è¨­å®š
     * ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å…¥åŠ›æ¬„ã®å¤‰æ›´ã‚’ç›£è¦–ã—ã€500mså¾Œã«è‡ªå‹•ã§ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å‡¦ç†ã‚’å®Ÿè¡Œ
     * é€£ç¶šå…¥åŠ›æ™‚ã¯ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ç„¡é§„ãªå‡¦ç†ã‚’é˜²ã
     */
    function setupAutoUpdate() {
      // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å…¥åŠ›æ¬„ã®å¤‰æ›´ã‚’ç›£è¦–
      const timelineInput = document.getElementById('timelineInput');
      timelineInput.addEventListener('input', function() {
        if (autoUpdateEnabled) {
          clearTimeout(autoUpdateTimer);
          autoUpdateTimer = setTimeout(() => {
            processTimelineWithErrorHandling();
          }, 500); // 500mså¾Œã«å®Ÿè¡Œï¼ˆé€£ç¶šå…¥åŠ›ã¸ã®å¯¾å¿œï¼‰
        }
      });

      console.log('è‡ªå‹•æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ');
    }

    /**
     * setupSettingsButtons - è¨­å®šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼åˆæœŸåŒ–
     * å„ç¨®è¨­å®šãƒœã‚¿ãƒ³ï¼ˆæˆ¦é—˜æ™‚é–“ã€SSã€ã‚³ã‚¹ãƒˆç­‰ï¼‰ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
     * è¨­å®šå¤‰æ›´æ™‚ã¯è‡ªå‹•ä¿å­˜ã¨è‡ªå‹•æ›´æ–°ã‚’å®Ÿè¡Œã™ã‚‹
     */
    function setupSettingsButtons() {
      // æˆ¦é—˜æ™‚é–“ãƒœã‚¿ãƒ³ã®è¨­å®š
      const ttButtons = Array.from(document.querySelectorAll('.btn[data-tt]'));
      ttButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          settings.battle_time = Number(btn.dataset.tt);
          updateActiveButtons();
          saveSettings(); // è¨­å®šã‚’è‡ªå‹•ä¿å­˜
          triggerAutoUpdate();
        });
      });

      // SSãƒœã‚¿ãƒ³ã®è¨­å®š
      const ssButtons = Array.from(document.querySelectorAll('.btn[data-ss]'));
      ssButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          settings.ss_enabled = btn.dataset.ss === 'on';
          updateActiveButtons();
          saveSettings(); // è¨­å®šã‚’è‡ªå‹•ä¿å­˜
          triggerAutoUpdate();
        });
      });

      // æœ€å¤§ã‚³ã‚¹ãƒˆãƒœã‚¿ãƒ³ã®è¨­å®š
      const limitButtons = Array.from(document.querySelectorAll('.btn[data-limit]'));
      limitButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          settings.max_cost = Number(btn.dataset.limit);
          updateActiveButtons();
          saveSettings(); // è¨­å®šã‚’è‡ªå‹•ä¿å­˜
          triggerAutoUpdate();
        });
      });

      // è¡Œé ­æ•°å­—è§£é‡ˆãƒœã‚¿ãƒ³ã®è¨­å®š
      const numberButtons = Array.from(document.querySelectorAll('.btn[data-number]'));
      numberButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          settings.number_interpretation = btn.dataset.number;
          updateActiveButtons();
          saveSettings(); // è¨­å®šã‚’è‡ªå‹•ä¿å­˜
          triggerAutoUpdate();
        });
      });

      // æ™‚é–“è¡¨ç¤ºå½¢å¼ãƒœã‚¿ãƒ³ã®è¨­å®š
      const displayButtons = Array.from(document.querySelectorAll('.btn[data-display]'));
      displayButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          settings.time_display_format = btn.dataset.display;
          updateActiveButtons();
          saveSettings(); // è¨­å®šã‚’è‡ªå‹•ä¿å­˜
          triggerAutoUpdate();
        });
      });

      // +/-è§£é‡ˆãƒœã‚¿ãƒ³ã®è¨­å®š
      const modifierButtons = Array.from(document.querySelectorAll('.btn[data-modifier]'));
      modifierButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          settings.modifier_always_forward = btn.dataset.modifier;
          updateActiveButtons();
          saveSettings(); // è¨­å®šã‚’è‡ªå‹•ä¿å­˜
          triggerAutoUpdate();
        });
      });

      // ã‚»ã‚¤ã‚¢å›ºæœ‰2ãƒœã‚¿ãƒ³ã®è¨­å®š
      const seiaButtons = Array.from(document.querySelectorAll('.btn[data-seia]'));
      seiaButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          settings.seia_koyuu2 = btn.dataset.seia;
          updateActiveButtons();
          saveSettings(); // è¨­å®šã‚’è‡ªå‹•ä¿å­˜
          triggerAutoUpdate();
        });
      });

      // ã‚«ãƒã‚¨ãƒœã‚¿ãƒ³ã®è¨­å®š
      const kanoeButtons = Array.from(document.querySelectorAll('.btn[data-kanoe]'));
      kanoeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          settings.kanoe_ss = btn.dataset.kanoe;
          updateActiveButtons();
          saveSettings(); // è¨­å®šã‚’è‡ªå‹•ä¿å­˜
          triggerAutoUpdate();
        });
      });

      // ãƒã‚§ãƒªãƒãƒœã‚¿ãƒ³ã®è¨­å®š
      const cherinoButtons = Array.from(document.querySelectorAll('.btn[data-cherino]'));
      cherinoButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          settings.cherino_ss = btn.dataset.cherino;
          updateActiveButtons();
          saveSettings(); // è¨­å®šã‚’è‡ªå‹•ä¿å­˜
          triggerAutoUpdate();
        });
      });

      // ç‰¹æ®Šã‚³ãƒãƒ³ãƒ‰ãƒœã‚¿ãƒ³ã®è¨­å®š
      const specialButtons = Array.from(document.querySelectorAll('.btn[data-special]'));
      specialButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          settings.special_command_accepted = btn.dataset.special;
          updateActiveButtons();
          saveSettings(); // è¨­å®šã‚’è‡ªå‹•ä¿å­˜
          triggerAutoUpdate();
        });
      });
    }

    /**
     * updateActiveButtons - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºæ›´æ–°
     * ç¾åœ¨ã®è¨­å®šå€¤ã«åŸºã¥ã„ã¦å„è¨­å®šãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
     * ç¾åœ¨å€¤ã®è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã‚‚åŒæ™‚ã«æ›´æ–°ã™ã‚‹
     */
    function updateActiveButtons() {
      // æˆ¦é—˜æ™‚é–“ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
      const ttButtons = Array.from(document.querySelectorAll('.btn[data-tt]'));
      ttButtons.forEach(btn => {
        const v = Number(btn.dataset.tt);
        btn.classList.toggle('active', v === settings.battle_time);
      });
      document.getElementById('currentTT').textContent = `(ç¾åœ¨: ${settings.battle_time}ç§’)`;

      // SSãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
      const ssButtons = Array.from(document.querySelectorAll('.btn[data-ss]'));
      ssButtons.forEach(btn => {
        const isOn = btn.dataset.ss === 'on';
        btn.classList.toggle('active', isOn === settings.ss_enabled);
      });
      document.getElementById('currentSS').textContent = `(ç¾åœ¨: ${settings.ss_enabled ? 'ã‚ªãƒ³' : 'ã‚ªãƒ•'})`;

      // æœ€å¤§ã‚³ã‚¹ãƒˆãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
      const limitButtons = Array.from(document.querySelectorAll('.btn[data-limit]'));
      limitButtons.forEach(btn => {
        const v = Number(btn.dataset.limit);
        btn.classList.toggle('active', v === settings.max_cost);
      });
      document.getElementById('currentLimit').textContent = `(ç¾åœ¨: ${settings.max_cost})`;

      // è¡Œé ­æ•°å­—è§£é‡ˆãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
      const numberButtons = Array.from(document.querySelectorAll('.btn[data-number]'));
      numberButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.number === settings.number_interpretation);
      });
      document.getElementById('currentNumber').textContent = `(ç¾åœ¨: ${settings.number_interpretation === 'time' ? 'ã‚¿ã‚¤ãƒ ' : 'ã‚³ã‚¹ãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°'})`;

      // æ™‚é–“è¡¨ç¤ºå½¢å¼ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
      const displayButtons = Array.from(document.querySelectorAll('.btn[data-display]'));
      displayButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.display === settings.time_display_format);
      });
      document.getElementById('currentDisplay').textContent = `(ç¾åœ¨: ${settings.time_display_format === 'backward' ? 'ã‚²ãƒ¼ãƒ å†…è¡¨ç¤º' : 'çµŒéæ™‚é–“'})`;

      // +/-è§£é‡ˆãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
      const modifierButtons = Array.from(document.querySelectorAll('.btn[data-modifier]'));
      modifierButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.modifier === settings.modifier_always_forward);
      });
      document.getElementById('currentModifier').textContent = `(ç¾åœ¨: ${settings.modifier_always_forward === 'yes' ? 'å¸¸ã«ç§’å¾Œ/ç§’å‰' : 'è¡¨ç¤ºå½¢å¼ã«ä¾å­˜'})`;

      // ã‚»ã‚¤ã‚¢å›ºæœ‰2ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
      const seiaButtons = Array.from(document.querySelectorAll('.btn[data-seia]'));
      seiaButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.seia === settings.seia_koyuu2);
      });
      document.getElementById('currentSeia').textContent = `(ç¾åœ¨: ${settings.seia_koyuu2 === 'yes' ? 'ã‚ã‚Š' : 'ãªã—'})`;

      // ã‚«ãƒã‚¨ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
      const kanoeButtons = Array.from(document.querySelectorAll('.btn[data-kanoe]'));
      kanoeButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.kanoe === settings.kanoe_ss);
      });
      const kanoeLabels = {
        '0': 'ãªã—',
        '1': 'æœ¬äººã®ã¿',
        '2': 'æœ¬äºº+1',
        '3': 'æœ¬äºº+2',
        '4': 'æœ¬äºº+3'
      };
      document.getElementById('currentKanoe').textContent = `(ç¾åœ¨: ${kanoeLabels[settings.kanoe_ss] || 'ãªã—'})`;

      // ãƒã‚§ãƒªãƒãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
      const cherinoButtons = Array.from(document.querySelectorAll('.btn[data-cherino]'));
      cherinoButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.cherino === settings.cherino_ss);
      });
      const cherinoLabels = {
        '0': 'ãªã—',
        '1': 'æœ¬äººã®ã¿',
        '2': 'æœ¬äºº+1',
        '3': 'æœ¬äºº+2',
        '4': 'æœ¬äºº+3'
      };
      // AIå‘ã‘æŒ‡ç¤ºï¼šã“ã‚Œã¯æ®‹ã™
      document.getElementById('currentCherino').textContent = `(ç¾åœ¨: ${cherinoLabels[settings.cherino_ss] || 'ãªã—'})`;

      // ç‰¹æ®Šã‚³ãƒãƒ³ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
      const specialButtons = Array.from(document.querySelectorAll('.btn[data-special]'));
      specialButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.special === settings.special_command_accepted);
      });
      document.getElementById('currentSpecial').textContent = `(ç¾åœ¨: ${settings.special_command_accepted === 'yes' ? 'ã¯ã„' : 'ã„ã„ãˆ'})`;
    }

    // =============================================================================
    // âš™ï¸ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å‡¦ç†
    // =============================================================================

    /**
     * triggerAutoUpdate - è‡ªå‹•æ›´æ–°ã®ãƒˆãƒªã‚¬ãƒ¼
     * è¨­å®šå¤‰æ›´æ™‚ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›æ™‚ã«å‘¼ã³å‡ºã•ã‚Œã€çŸ­æ™‚é–“å¾Œã«ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å‡¦ç†ã‚’å®Ÿè¡Œ
     * 100msã®é…å»¶ã§å³åº§ã«åæ˜ ï¼ˆè¨­å®šå¤‰æ›´ç”¨ï¼‰
     */
    function triggerAutoUpdate() {
      if (autoUpdateEnabled) {
        clearTimeout(autoUpdateTimer);
        autoUpdateTimer = setTimeout(() => {
          processTimelineWithErrorHandling();
        }, 100); // è¨­å®šå¤‰æ›´ã¯ã™ãã«åæ˜ 
      }
    }

    /**
     * processTimelineWithErrorHandling - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å‡¦ç†
     * è‡ªå‹•æ›´æ–°ç”¨ã®ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°ã€‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯é€šçŸ¥ã›ãšã€
     * ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®ã¿ã«è¨˜éŒ²ã™ã‚‹
     */
    async function processTimelineWithErrorHandling() {
      try {
        const input = document.getElementById('timelineInput').value.trim();
        if (input) {
          // è‡ªå‹•æ›´æ–°ä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°
          const isAutoUpdate = true;
          await processTimeline(isAutoUpdate);
        } else {
          // å…¥åŠ›ãŒç©ºã®å ´åˆã¯çµæœã‚’ã‚¯ãƒªã‚¢
          document.getElementById('timelineOutput').innerHTML = '<div class="info-message">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
          document.getElementById('timelineSection').style.display = 'none';
          document.getElementById('debugInfo').innerHTML = '';
          document.getElementById('jsonOutput').innerHTML = '';
        }
      } catch (error) {
        console.warn('è‡ªå‹•æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
        // è‡ªå‹•æ›´æ–°ã§ã®ã‚¨ãƒ©ãƒ¼ã¯é™ã‹ã«å‡¦ç†ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è­¦å‘Šã¯è¡¨ç¤ºã—ãªã„ï¼‰
      }
    }

    /**
     * checkDependencies - å¿…è¦ãªå¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ç¢ºèª
     * @returns {boolean} å…¨ã¦ã®ä¾å­˜é–¢ä¿‚ãŒæº€ãŸã•ã‚Œã¦ã„ã‚‹å ´åˆã¯true
     * 
     * ä»¥ä¸‹ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ãã®ä¸»è¦é–¢æ•°ã®å­˜åœ¨ã‚’ç¢ºèª:
     * - utilities.js: parseTimeToSecondsç­‰ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
     * - input-processor.js: createInputJSONé–¢æ•°  
     * - tl-editor.js: TimelineProcessorã‚¯ãƒ©ã‚¹
     * - timeline-formatter.js: generateTimelineHTMLé–¢æ•°
     */
    function checkDependencies() {
      const missing = [];
      const details = [];
      
      // utilities.jsã®ç¢ºèª
      if (typeof window.Utilities === 'undefined') {
        missing.push('utilities.js');
        details.push('window.Utilities ãŒ undefined');
      } else {
        details.push('âœ“ utilities.js OK');
      }
      
      // input-processor.jsã®ç¢ºèª
      if (typeof window.InputProcessor === 'undefined') {
        missing.push('input-processor.js');
        details.push('window.InputProcessor ãŒ undefined');
      } else {
        if (typeof window.InputProcessor.createInputJSON === 'undefined') {
          missing.push('input-processor.js (createInputJSONé–¢æ•°ãªã—)');
          details.push('window.InputProcessor.createInputJSON ãŒ undefined');
        } else {
          details.push('âœ“ input-processor.js OK');
        }
      }
      
      // tl-editor.jsã®ç¢ºèª
      if (typeof window.TLEditor === 'undefined') {
        missing.push('tl-editor.js');
        details.push('window.TLEditor ãŒ undefined');
      } else {
        // TimelineProcessorã‚¯ãƒ©ã‚¹ã®å­˜åœ¨ç¢ºèª
        if (typeof window.TLEditor.TimelineProcessor === 'undefined') {
          missing.push('tl-editor.js (TimelineProcessorã‚¯ãƒ©ã‚¹ãªã—)');
          details.push('window.TLEditor.TimelineProcessor ãŒ undefined');
        } else {
          details.push('âœ“ tl-editor.js OK (TimelineProcessoråˆ©ç”¨å¯èƒ½)');
        }
      }

      // timeline-formatter.jsã®ç¢ºèª
      if (typeof window.TimelineFormatter === 'undefined') {
        missing.push('timeline-formatter.js');
        details.push('window.TimelineFormatter ãŒ undefined');
      } else {
        if (typeof window.TimelineFormatter.generateTimelineHTML === 'undefined') {
          missing.push('timeline-formatter.js (generateTimelineHTMLé–¢æ•°ãªã—)');
          details.push('window.TimelineFormatter.generateTimelineHTML ãŒ undefined');
        } else {
          details.push('âœ“ timeline-formatter.js OK');
        }
      }
      
      // è©³ç´°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
      console.log('Dependencies check:', details);
      
      if (missing.length > 0) {
        const errorMsg = `å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“: ${missing.join(', ')}\n\nè©³ç´°:\n${details.join('\n')}`;
        showMessage(errorMsg, 'error');
        return false;
      }
      
      return true;
    }

    /**
     * processTimeline - ãƒ¡ã‚¤ãƒ³ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å‡¦ç†é–¢æ•°
     * @param {boolean} isAutoUpdate - è‡ªå‹•æ›´æ–°ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ï¼ˆã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã®åˆ¶å¾¡ï¼‰
     * 
     * å‡¦ç†ã®æµã‚Œ:
     * 1. ä¾å­˜é–¢ä¿‚ã®ç¢ºèª
     * 2. è¨­å®šå€¤ã®åé›†
     * 3. å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ï¼ˆInputProcessorï¼‰
     * 4. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆï¼ˆTLEditor.TimelineProcessorï¼‰
     * 5. çµæœã®è¡¨ç¤ºï¼ˆHTMLã€ãƒ†ã‚­ã‚¹ãƒˆã€ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã€JSONï¼‰
     */
    async function processTimeline(isAutoUpdate = false) {
      try {
        // ä¾å­˜é–¢ä¿‚ã®ç¢ºèª
        if (!checkDependencies()) {
          return;
        }

        // ãƒãƒ•ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯èª­ã¿è¾¼ã‚€
        if (!buffData) {
          console.log('ãƒãƒ•ãƒ‡ãƒ¼ã‚¿ãŒæœªèª­ã¿è¾¼ã¿ã®ãŸã‚ã€èª­ã¿è¾¼ã¿ä¸­...');
          loadBuffData();
        }

        const input = document.getElementById('timelineInput').value.trim();
        console.log('å…¥åŠ›ãƒ‡ãƒ¼ã‚¿:', JSON.stringify(input));
        
        if (!input) {
          if (!isAutoUpdate) {
            showMessage('ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
          }
          return;
        }

        ///////////////////////////////////////////////////////
        // ã€é‡è¦ã€‘ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç›´æ¥ä½¿ç”¨
        ///////////////////////////////////////////////////////

        // å…¥åŠ›å‡¦ç†ãƒ•ã‚§ãƒ¼ã‚º
        try {
          console.log('InputProcessor.createInputJSON å®Ÿè¡Œé–‹å§‹');
          const processedTimeline = window.InputProcessor.createInputJSON(input, settings);
          console.log('å‡¦ç†ã•ã‚ŒãŸå…¥åŠ›ãƒ‡ãƒ¼ã‚¿:', processedTimeline);
          
          if (!processedTimeline || processedTimeline.length === 0) {
            throw new Error('å…¥åŠ›å‡¦ç†ã®çµæœãŒç©ºã§ã™');
          }
          
          currentInputJSON = {
            timeline: processedTimeline,
            metadata: {
              input_length: processedTimeline.length,
              processed_at: new Date().toISOString()
            }
          };
          console.log('currentInputJSON:', currentInputJSON);
          if (!isAutoUpdate) {
            showMessage('å…¥åŠ›å‡¦ç†å®Œäº†', 'success');
          }
        } catch (inputError) {
          throw new Error(`å…¥åŠ›å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${inputError.message}`);
        }

        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆãƒ•ã‚§ãƒ¼ã‚º
        try {
          console.log('TimelineProcessorä½œæˆæ™‚ã®buffData:', buffData);
          const processor = new window.TLEditor.TimelineProcessor(currentInputJSON, settings, buffData);
          currentTimelineJSON = processor.createTimelineJSON();
          
          console.log('ç”Ÿæˆã•ã‚ŒãŸtimeline_json:', currentTimelineJSON);
          console.log('additional_events:', currentTimelineJSON.additional_events);
          
          if (!isAutoUpdate) {
            showMessage('ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆå®Œäº†', 'success');
          }
        } catch (timelineError) {
          throw new Error(`ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${timelineError.message}`);
        }

        // çµæœè¡¨ç¤ºãƒ•ã‚§ãƒ¼ã‚º
        displayTimelineResults(currentTimelineJSON);
        displayDebugInfo(currentInputJSON, currentTimelineJSON);
        displayJSONOutput(currentTimelineJSON);

      } catch (error) {
        if (!isAutoUpdate) {
          showMessage(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        }
        console.error('ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // =============================================================================
    // ğŸ“Š è¡¨ç¤ºãƒ»å‡ºåŠ›
    // =============================================================================
    
    /**
     * displayTimelineResults - ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³çµæœã®è¡¨ç¤º
     * @param {Object} timelineJSON - ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³JSONãƒ‡ãƒ¼ã‚¿
     * 
     * HTMLã¨ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã®ä¸¡æ–¹ã§ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’ç”Ÿæˆãƒ»è¡¨ç¤º
     * ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«ã€ã‚³ã‚¹ãƒˆãƒã‚¤ãƒ³ãƒˆè©³ç´°ã€è¿½åŠ ã‚¤ãƒ™ãƒ³ãƒˆã‚‚å«ã‚€
     */
    function displayTimelineResults(timelineJSON) {
      // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
      document.getElementById('timelineSection').style.display = 'block';
      
      // HTMLã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º
      try {
        const result = window.TimelineFormatter.generateTimelineNew(timelineJSON, {
          battle_time: settings.battle_time
        });
        document.getElementById('timelineDisplay').innerHTML = result.html;
      } catch (error) {
        console.error('ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³HTMLç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('timelineDisplay').innerHTML = '<p>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message + '</p>';
      }
      
      // ãƒ†ã‚­ã‚¹ãƒˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆ
      try {
        const result = window.TimelineFormatter.generateTimelineNew(timelineJSON, {
          battle_time: settings.battle_time
        });
        document.getElementById('timelineTextOutput').value = result.text;
      } catch (error) {
        console.error('ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('timelineTextOutput').value = 'ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message;
      }
      
      const output = document.getElementById('timelineOutput');
      
      // è©³ç´°ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«ã®ç”Ÿæˆ
      let html = `<table>
          <thead>
            <tr>
              <th>çµŒéæ™‚é–“</th>
              <th>ãƒ•ãƒ¬ãƒ¼ãƒ </th>
              <th>ã‚¤ãƒ™ãƒ³ãƒˆå</th>
              <th>ä½¿ç”¨ã‚³ã‚¹ãƒˆ</th>
              <th>æ®‹ã‚Šã‚³ã‚¹ãƒˆ</th>
              <th>ã‚ãµã‚ŒãŸã‚³ã‚¹ãƒˆ</th>
              <th>æ®‹ã‚Šã‚³ã‚¹ãƒˆãƒã‚¤ãƒ³ãƒˆ</th>
              <th>ç·ã‚³ã‚¹ãƒˆå›å¾©åŠ›</th>
            </tr>
          </thead>
          <tbody>
      `;

      // å„ã‚¤ãƒ™ãƒ³ãƒˆã®è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
      for (const event of timelineJSON.timeline) {
        const costPoints = event.remaining_cost_points !== undefined ? event.remaining_cost_points.toLocaleString() : 'N/A';
        const totalCostRecovery = event.total_cost_recovery !== undefined ? event.total_cost_recovery.toLocaleString() : 'N/A';
        // timeãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆã¯frameã‹ã‚‰è¨ˆç®—
        const eventTime = event.time !== undefined ? event.time : (event.frame / 30);
        
        // ã‚ãµã‚ŒãŸã‚³ã‚¹ãƒˆï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ï¼‰ã®è¡¨ç¤º
        const overflowCost = event.overflow_cost !== undefined ? event.overflow_cost.toFixed(1) : '0.0';
        const overflowDisplay = parseFloat(overflowCost) > 0 ? 
          `<span class="cost-overflow">${overflowCost}</span>` : overflowCost;
        
        html += `
          <tr>
            <td>${eventTime.toFixed(3)}</td>
            <td>${event.frame}</td>
            <td style="text-align: left;">${event.event_name}</td>
            <td>${event.cost_used.toFixed(1)}</td>
            <td>${event.current_cost_display_only.toFixed(1)}</td>
            <td>${overflowDisplay}</td>
            <td style="color: #059669; font-family: monospace;">${costPoints}</td>
            <td style="color: #1976d2; font-family: monospace;">${totalCostRecovery}</td>
          </tr>
        `;
      }

      html += `
          </tbody>
        </table>
        
        <div class="setting-comment">
          ã‚³ã‚¹ãƒˆãƒã‚¤ãƒ³ãƒˆï¼šå†…éƒ¨çš„ã«ã¯ã‚³ã‚¹ãƒˆç®¡ç†ã¯æ•´æ•°å€¤ã§ç®¡ç†ã•ã‚Œã¦ã„ã‚‹ã¨æƒ³å®šã—ã¾ã™ã€‚1ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«ç·ã‚³ã‚¹ãƒˆå›å¾©åŠ›ã¨ç­‰ã—ã„æ•°å€¤ã‚’ç²å¾—ã—ã¦ã„ã‚‹ã¨ã—ã€ãã®è“„ç©ã•ã‚ŒãŸå€¤ã‚’ã‚³ã‚¹ãƒˆãƒã‚¤ãƒ³ãƒˆã¨å‘¼ã¶ã“ã¨ã«ã—ã¾ã™ã€‚300,000ã‚³ã‚¹ãƒˆãƒã‚¤ãƒ³ãƒˆ ï¼ 1ã‚³ã‚¹ãƒˆã§ã™ã€‚
        </div>
      `;

      // è¿½åŠ ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒãƒ•ç­‰ï¼‰ã®è¡¨ç¤º
      if (timelineJSON.additional_events.length > 0) {
        html += `
          <h4>ğŸ­ è¿½åŠ ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚³ã‚¹ãƒˆå›å¾©ãƒãƒ•ç­‰ï¼‰</h4>
          <table>
            <thead>
              <tr>
                <th>é–‹å§‹çµŒéæ™‚é–“</th>
                <th>çµ‚äº†çµŒéæ™‚é–“</th>
                <th>ã‚¤ãƒ™ãƒ³ãƒˆå</th>
                <th>ç¶™ç¶šæ™‚é–“</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        // AIç”¨æŒ‡ç¤ºï¼šæœ€çµ‚çš„ã«framesToSecondsãŒhtmlå†…ã«å…¥ã‚Šè¾¼ã‚€ã®ã¯æœ›ã¾ã—ããªã„
        // å¯èƒ½ã§ã‚ã‚Œã°ã„ãšã‚Œã“ã®éƒ¨åˆ†ã®å‡¦ç†ã‚’jsãƒ•ã‚¡ã‚¤ãƒ«å†…ã§è¡Œã†
        // ãŸã ã—ã“ã®éƒ¨åˆ†ã¯å¿…é ˆã§ã¯ãªã„ã®ã§ã€å¾Œå›ã—ã«ã—ã¦ã‚‚è‰¯ã„
        for (const event of timelineJSON.additional_events) {
          const startTime = window.Utilities.framesToSeconds(event.start_frame).toFixed(3);
          const endTime = window.Utilities.framesToSeconds(event.end_frame).toFixed(3);
          const duration = (event.duration / 1000).toFixed(3);
          
          html += `
            <tr>
              <td>${startTime}s</td>
              <td>${endTime}s</td>
              <td style="text-align: left;">${event.event_name}</td>
              <td>${duration}s</td>
            </tr>
          `;
        }

        html += `
            </tbody>
          </table>
        `;
      }

      output.innerHTML = html;
    }

    /**
     * displayDebugInfo - ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®è¡¨ç¤º
     * @param {Object} inputJSON - å…¥åŠ›å‡¦ç†çµæœã®JSON
     * @param {Object} timelineJSON - ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆçµæœã®JSON
     * 
     * å…¥åŠ›JSONæ§‹é€ ã¨å‡¦ç†çµ±è¨ˆã‚’è¡¨ç¤ºã—ã¦é–‹ç™ºãƒ»ãƒ‡ãƒãƒƒã‚°ã‚’æ”¯æ´
     */
    function displayDebugInfo(inputJSON, timelineJSON) {
      const debug = document.getElementById('debugInfo');
      
      let html = `
        <h4>ğŸ”§ å…¥åŠ›JSONæ§‹é€ </h4>
        <div class="json-output">${JSON.stringify(inputJSON, null, 2)}</div>
        
        <h4>ğŸ“Š å‡¦ç†çµ±è¨ˆ</h4>
        <ul>
          <li>å…¥åŠ›è¡Œæ•°: ${inputJSON.timeline.length}</li>
          <li>ãƒ©ãƒ™ãƒ«æ•°: ${Object.keys(inputJSON.labels || {}).length}</li>
          <li>å‚ç…§è§£æ±ºæ•°: ${inputJSON.timeline.filter(row => row.reference).length}</li>
          <li>ã‚³ã‚¹ãƒˆè¨ˆç®—è¡Œæ•°: ${inputJSON.timeline.filter(row => row.cost > 0).length}</li>
        </ul>
      `;

      debug.innerHTML = html;
    }

    /**
     * displayJSONOutput - JSONå‡ºåŠ›ã®è¡¨ç¤º
     * @param {Object} timelineJSON - ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³JSONãƒ‡ãƒ¼ã‚¿
     * 
     * æ•´å½¢ã•ã‚ŒãŸJSONã‚’è¡¨ç¤ºã—ã€ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã‚’æä¾›
     */
    function displayJSONOutput(timelineJSON) {
      const output = document.getElementById('jsonOutput');
      output.innerHTML = `
        <div class="json-output">${JSON.stringify(timelineJSON, null, 2)}</div>
        <button class="btn" onclick="copyToClipboard()" style="margin-top: 12px;">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
      `;
    }

    // =============================================================================
    // ğŸ”§ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ»UI
    // =============================================================================

    /**
     * showMessage - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
     * @param {string} text - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     * @param {string} type - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ï¼ˆ'info', 'success', 'error'ï¼‰
     * 
     * ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯æ‰‹å‹•ã§é–‰ã˜ã‚‹ã¾ã§è¡¨ç¤ºã€æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯3ç§’ã§è‡ªå‹•æ¶ˆå»
     */
    function showMessage(text, type = 'info') {
      // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
      const existing = document.querySelector('.error-message, .success-message, .info-message');
      if (existing) existing.remove();

      const div = document.createElement('div');
      div.className = `${type}-message`;
      div.textContent = text;
      
      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
      if (type === 'error') {
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'âœ•';
        closeBtn.style.cssText = 'float: right; background: none; border: none; font-size: 1.2rem; cursor: pointer; color: inherit;';
        closeBtn.onclick = () => div.remove();
        div.appendChild(closeBtn);
        div.style.paddingRight = '40px';
      } else {
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯3ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
        setTimeout(() => div.remove(), 3000);
      }
      
      document.querySelector('.main-content').insertBefore(div, document.querySelector('.timeline-container'));
    }

    /**
     * toggleAccordion - ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³UI ã®é–‹é–‰åˆ‡ã‚Šæ›¿ãˆ
     * @param {HTMLElement} header - ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒ˜ãƒƒãƒ€ãƒ¼è¦ç´ 
     */
    function toggleAccordion(header) {
      const accordion = header.parentElement;
      accordion.classList.toggle('open');
    }

    /**
     * clearAll - å…¨ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªã‚¢
     * å…¥åŠ›ã€å‡ºåŠ›ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã€ã‚¿ã‚¤ãƒãƒ¼ã‚’å…¨ã¦ãƒªã‚»ãƒƒãƒˆã™ã‚‹
     */
    function clearAll() {
      document.getElementById('timelineInput').value = '';
      document.getElementById('timelineOutput').innerHTML = '<div class="info-message">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ</div>';
      document.getElementById('debugInfo').innerHTML = '';
      document.getElementById('jsonOutput').innerHTML = '';
      document.getElementById('timelineSection').style.display = 'none';
      currentTimelineJSON = null;
      currentInputJSON = null;
      
      // ã‚¿ã‚¤ãƒãƒ¼ã‚‚ã‚¯ãƒªã‚¢
      clearTimeout(autoUpdateTimer);
    }

    /**
     * loadSampleTimeline - ã‚µãƒ³ãƒ—ãƒ«ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®èª­ã¿è¾¼ã¿
     * @param {number} sampleNumber - èª­ã¿è¾¼ã‚€ã‚µãƒ³ãƒ—ãƒ«ç•ªå·ï¼ˆ1-5ï¼‰
     * 
     * äº‹å‰å®šç¾©ã•ã‚ŒãŸã‚µãƒ³ãƒ—ãƒ«ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å…¥åŠ›æ¬„ã«è¨­å®šã—ã€è‡ªå‹•æ›´æ–°ã‚’å®Ÿè¡Œ
     * AIå‘ã‘æŒ‡ç¤ºï¼šã‚µãƒ³ãƒ—ãƒ«å†…å®¹ã¯ãã®ã¾ã¾ç¶­æŒã™ã‚‹ã“ã¨
     */
    function loadSampleTimeline(sampleNumber) {
      let sample = '';
      
      switch(sampleNumber) {
        case 1:
          sample = `ã‚·ãƒ¥ãƒ³NS -3.8 ã‚³ã‚¹ãƒˆå›å¾©è¡¨ç¾å¯
[5]ãƒŠã‚®ã‚µ 3 å›ºæœ‰2ãªã„å ´åˆ6ã‚³ã‚¹
[7]ãƒªã‚ª 2
#seia - 1.900 æœ¬ã‚¢ãƒªã‚¹ 4 #a
ã‚«ãƒ³ãƒŠ[2] é †ä¸åŒã€ã‚¹ã‚­ãƒ«ã‚«ãƒ¼ãƒ‰ã‚¬ãƒãƒ£å›é¿
02:37.800 æ°´ç€ã‚»ã‚¤ã‚¢[3] #seia 
#a+4.000 ï¼£ã‚¢ãƒªã‚¹ 3 #a2
#a2+4 æœ¬ã‚¢ãƒªã‚¹ 4 #a3
#a3+2.833 ã€†

ï¼ã‚»ã‚¤ã‚¢ã®ã‚¿ã‚¤ãƒ æŒ‡å®šã‚’[3]ã«ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã™ã€‚è©¦ã—ã¦ã¿ã¦ãã ã•ã„
ï¼è¡Œé ­ã«ã€Œï¼ã€ã‚’æ›¸ãã¨ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã«ãªã‚Šç„¡è¦–ã•ã‚Œã¾ã™
!å…¨è§’ã§ã‚‚åŠè§’ã§ã‚‚ã„ã„ã§ã™ãŒã€çµµæ–‡å­—ã¯ãƒ€ãƒ¡ã§ã™â—`;
          break;
          
        case 2:
          sample = `
æ°´ç€ãƒ›ã‚·ãƒ[5]
ã‚»ã‚¤ã‚¢[3]
ãƒªã‚ª[2]
ã‚­ã‚µã‚­[3]
[6]ãƒŸã‚«[3] #ãƒŸã‚«1
ãƒ‰ã‚¢ãƒ«[3]
#ãƒŸã‚«1 +1.1 ï¼£ãƒŸã‚«[3] #ãƒŸã‚«2
ã‚»ã‚¤ã‚¢[3]
#ãƒŸã‚«2 +1.3 ãƒŸã‚«[3] #ãƒŸã‚«3`;
          break;
          
        case 3:
          sample = `1:15.867 ã‚¤ãƒ–ã‚­[3] #ã‚¤ãƒ–ã‚­
2:02.433 ã‚¤ãƒ­ãƒ 6 #ã‚¤ãƒ­ãƒ
[5.85]ã‚µãƒ„ã‚­ 5
[0.1]ãƒã‚¢ã‚­ 6 #ãƒã‚¢ã‚­
#ã‚¤ãƒ­ãƒ - 2.5 ãƒã‚³ãƒˆ 6 #ã‚¤ãƒ­ãƒ2
#ã‚µãƒ„ã‚­+1.1 ã‚¤ãƒ–ã‚­ 3`;;
          break;
          
        case 4:
          sample = `ã‚»ã‚¤ã‚¢[3]
ãƒãƒ¬ã‚­ãƒ£ãƒ³ãƒ—[2]
æ°´ç€ãƒ›ã‚·ãƒ[5]
ã‚»ã‚¤ã‚¢[3]
ãƒãƒ¬ã‚­ãƒ£ãƒ³ãƒ—[2]
ã‚»ã‚¤ã‚¢[3]
ãƒãƒ¬ã‚­ãƒ£ãƒ³ãƒ—[2]
ã‚»ã‚¤ã‚¢[3]
ãƒãƒ¬ã‚­ãƒ£ãƒ³ãƒ—[2]
æ°´ç€ãƒ’ãƒ•ãƒŸ[10]
ã‚»ã‚¤ã‚¢[3]
ãƒãƒ¬ã‚­ãƒ£ãƒ³ãƒ—[2]
ã‚»ã‚¤ã‚¢[3]
ãƒãƒ¬ã‚­ãƒ£ãƒ³ãƒ—[2]`;
          break;
          
        case 5:
          sample = `æ°´ç€ãƒ›ã‚·ãƒ[5]
[9.95]ãƒŸã‚«[6]
ã‚­ã‚µã‚­[3]
ã‚¢ã‚³[3]
æ°´ç€ãƒ›ã‚·ãƒ[5]
ãƒãƒ³ãƒ‰ãƒ¨ã‚·ãƒŸ[10]
[9.95]ãƒŸã‚«[6]
ã‚­ã‚µã‚­[3]
ã‚¢ã‚³[3]
æ°´ç€ãƒ›ã‚·ãƒ[5]`;
          break;

        case 6:
          sample = `ï¼è¡Œé ­ã«ã€Œï¼ã€ã‚’æ›¸ãã¨ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã«ãªã‚Šç„¡è¦–ã•ã‚Œã¾ã™
!å…¨è§’ã§ã‚‚åŠè§’ã§ã‚‚ã„ã„ã§ã™ãŒã€çµµæ–‡å­—ã¯ãƒ€ãƒ¡ã§ã™â—
ï¼ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’è©¦ã—ãŸã„å ´åˆã¯ã‚µãƒ³ãƒ—ãƒ«6ã‚’æŠ¼ã—ã¦ãã ã•ã„
[5.0]æ°´ç€ãƒŠã‚®ã‚µ[3]
[6]ãƒãƒ¬[2] ä¸ŠæŒ¯ã‚Œã¦SSã§è¼ãƒšãƒ­ãƒ­å€’ã™ã¨ãƒªã‚¹ã‚¿
[8.5]ã‚«ãƒã‚¨[3]
[9.9]ã‚«ãƒ¨ã‚³[2]
[9.9]è‡¨æˆ¦[6]
03:22 ã‚­ã‚µã‚­[3]
03:18.433 ãƒŠã‚®ã‚µ[3]
03:14 ãƒãƒ¬[2] 
3:08.5 è‡¨æˆ¦[6]
[2]ã‚«ãƒ¨ã‚³[2]
[7]ãƒŠã‚®ã‚µ[3]
[5]ãƒãƒ¬[2]
[8.8]å³ç«¯è¼ããƒšãƒ­ãƒ­ãŒæŒ¯ã‚Šè¿”ã‚‹ç›´å‰è‡¨æˆ¦[6]
ã‚­ã‚µã‚­[3]
[4]ã‚«ãƒ¨ã‚³æ­©ãã¯ã˜ã‚ãŸã‚‰ã€è¶³æ­¢ã‚ã‚«ãƒ¨ã‚³EX[2]
ã‚«ãƒã‚¨[3]
[4]NSå¾Œãƒãƒ¬[2]
[3]ãƒŠã‚®ã‚µ[3]
[9.9]è‡¨æˆ¦[6]
ã‚­ã‚µã‚­[3]
ã‚«ãƒ¨ã‚³[2]
01:53.900 ãƒãƒ¬[2]
[1]è‡¨æˆ¦[6]`;
          break;

        case 7:
          sample = `2:45 ã‚³ã‚¹ãƒˆå›å¾©åŠ›å¢—åŠ  500 5ç§’
2:42 ã‚¤ã‚ªãƒª 3
2:40 ã‚­ã‚µã‚­ 3`;
          break;

        default:
          sample = '';
      }
      
      if (sample) {
        document.getElementById('timelineInput').value = sample;
        showMessage(`ã‚µãƒ³ãƒ—ãƒ«${sampleNumber}ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');
        
        // è‡ªå‹•æ›´æ–°ã‚’ä½¿ç”¨ã—ã¦å‡¦ç†ã‚’å®Ÿè¡Œ
        triggerAutoUpdate();
      }
    }

    /**
     * toggleAutoUpdate - è‡ªå‹•æ›´æ–°æ©Ÿèƒ½ã®ON/OFFåˆ‡ã‚Šæ›¿ãˆ
     * ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°ã—ã€æœ‰åŠ¹æ™‚ã¯ç¾åœ¨ã®å…¥åŠ›ã§å³åº§ã«æ›´æ–°ã‚’å®Ÿè¡Œ
     */
    function toggleAutoUpdate() {
      autoUpdateEnabled = !autoUpdateEnabled;
      const button = document.getElementById('autoUpdateToggle');
      
      if (autoUpdateEnabled) {
        button.textContent = 'ğŸ”„ è‡ªå‹•æ›´æ–°: ON';
        button.classList.add('active');
        showMessage('è‡ªå‹•æ›´æ–°ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸ', 'success');
        
        // è‡ªå‹•æ›´æ–°ã‚’æœ‰åŠ¹ã«ã—ãŸæ™‚ã«ç¾åœ¨ã®å†…å®¹ã§å³åº§ã«æ›´æ–°
        const input = document.getElementById('timelineInput').value.trim();
        if (input) {
          triggerAutoUpdate();
        }
      } else {
        button.textContent = 'ğŸ”„ è‡ªå‹•æ›´æ–°: OFF';
        button.classList.remove('active');
        showMessage('è‡ªå‹•æ›´æ–°ã‚’ç„¡åŠ¹ã«ã—ã¾ã—ãŸ', 'info');
        
        // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
        clearTimeout(autoUpdateTimer);
      }
    }

    // =============================================================================
    // ğŸš¨ é‡è¤‡é–¢æ•° - TODO: ã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰çµ±åˆå¾Œã«å‰Šé™¤äºˆå®š
    // =============================================================================
    // ğŸ“‹ ã‚³ãƒ”ãƒ¼ãƒ»ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰
    // =============================================================================

    /**
     * copyToClipboard - ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³JSONã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
     * ç¾åœ¨ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³JSONã‚’æ•´å½¢ã—ã¦ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«é€ã‚‹
     */
    function copyToClipboard() {
      if (!currentTimelineJSON) return;
      
      navigator.clipboard.writeText(JSON.stringify(currentTimelineJSON, null, 2))
        .then(() => showMessage('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success'))
        .catch(() => showMessage('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error'));
    }

    /**
     * copyTimelineText - ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
     * ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«é€ã‚‹
     * ãƒ¢ãƒã‚¤ãƒ«ç«¯æœ«ã§ã®é¸æŠã«ã‚‚å¯¾å¿œ
     */
    function copyTimelineText() {
      const textarea = document.getElementById('timelineTextOutput');
      textarea.select();
      textarea.setSelectionRange(0, 99999); // ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ
      
      navigator.clipboard.writeText(textarea.value)
        .then(() => showMessage('ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success'))
        .catch(() => showMessage('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error'));
    }
  </script>
</body>
</html>

